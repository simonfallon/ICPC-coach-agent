<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ICPC Coach â€” Codeforces Intelligence</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link
    href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:ital,wght@0,300;0,400;0,500;0,600;0,700;1,400&display=swap"
    rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked@9/marked.min.js"></script>
  <style>
    :root {
      --bg-base: #080c13;
      --bg-sidebar: #0b0f18;
      --bg-surface: #0f1622;
      --bg-elevated: #162030;
      --bg-input: #0d1420;
      --border: #1c2d42;
      --border-subtle: #111e2e;
      --text-primary: #dde6f4;
      --text-secondary: #6e86a0;
      --text-muted: #3d5470;
      --blue: #1890ff;
      --blue-dim: rgba(24, 144, 255, 0.12);
      --blue-glow: rgba(24, 144, 255, 0.2);
      --orange: #f0a500;
      --orange-dim: rgba(240, 165, 0, 0.1);
      --green: #23d18b;
      --red: #f14c60;
      --font: 'JetBrains Mono', monospace;
    }

    *,
    *::before,
    *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html,
    body {
      height: 100%;
      font-family: var(--font);
      font-size: 13px;
      background: var(--bg-base);
      color: var(--text-primary);
      overflow: hidden;
    }

    ::-webkit-scrollbar {
      width: 3px;
      height: 3px;
    }

    ::-webkit-scrollbar-track {
      background: transparent;
    }

    ::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 2px;
    }

    /* â”€â”€â”€ App Shell â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .app {
      display: flex;
      height: 100vh;
    }

    /* â”€â”€â”€ Sidebar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .sidebar {
      width: 256px;
      flex-shrink: 0;
      background: var(--bg-sidebar);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      position: relative;
    }

    .sidebar::after {
      content: '';
      position: absolute;
      inset: 0;
      background-image: radial-gradient(circle, rgba(24, 144, 255, 0.05) 1px, transparent 1px);
      background-size: 22px 22px;
      pointer-events: none;
      z-index: 0;
    }

    .sidebar>* {
      position: relative;
      z-index: 1;
    }

    .sidebar-top {
      padding: 18px 16px 14px;
      border-bottom: 1px solid var(--border-subtle);
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 9px;
    }

    .brand-trophy {
      font-size: 19px;
      filter: drop-shadow(0 0 8px rgba(240, 165, 0, 0.5));
    }

    .brand-text {
      display: flex;
      flex-direction: column;
    }

    .brand-name {
      font-size: 13px;
      font-weight: 700;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      color: var(--text-primary);
    }

    .brand-name em {
      font-style: normal;
      color: var(--blue);
    }

    .brand-sub {
      font-size: 9px;
      letter-spacing: 0.15em;
      text-transform: uppercase;
      color: var(--text-muted);
      margin-top: 1px;
    }

    .new-btn {
      margin: 12px 0 0;
      width: 100%;
      padding: 7px 12px;
      background: transparent;
      border: 1px solid var(--border);
      border-radius: 3px;
      color: var(--text-secondary);
      font-family: var(--font);
      font-size: 10px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: border-color 0.15s, color 0.15s, background 0.15s;
    }

    .new-btn:hover {
      border-color: var(--blue);
      color: var(--blue);
      background: var(--blue-dim);
    }

    .history-label {
      padding: 10px 16px 5px;
      font-size: 9px;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      color: var(--text-muted);
    }

    .history-list {
      flex: 1;
      overflow-y: auto;
      padding: 2px 8px 12px;
    }

    .history-item {
      padding: 7px 10px;
      border-radius: 3px;
      cursor: pointer;
      color: var(--text-secondary);
      font-size: 11px;
      line-height: 1.4;
      margin-bottom: 1px;
      border: 1px solid transparent;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      transition: background 0.1s, border-color 0.1s, color 0.1s;
    }

    .history-item:hover {
      background: var(--bg-elevated);
      border-color: var(--border);
      color: var(--text-primary);
    }

    .history-item.active {
      background: var(--blue-dim);
      border-color: rgba(24, 144, 255, 0.28);
      color: var(--blue);
    }

    .history-item .idx {
      font-size: 9px;
      color: var(--text-muted);
      margin-right: 5px;
    }

    .history-empty {
      padding: 10px;
      color: var(--text-muted);
      font-size: 11px;
      font-style: italic;
    }

    .sidebar-foot {
      padding: 10px 16px;
      border-top: 1px solid var(--border-subtle);
      display: flex;
      align-items: center;
      gap: 7px;
      font-size: 10px;
      color: var(--text-muted);
    }

    .dot {
      width: 5px;
      height: 5px;
      border-radius: 50%;
      background: var(--green);
      animation: pulse 2.5s ease-in-out infinite;
    }

    @keyframes pulse {

      0%,
      100% {
        opacity: 1
      }

      50% {
        opacity: 0.35
      }
    }

    /* â”€â”€â”€ Main â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .main {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      position: relative;
    }

    /* subtle grid on main bg */
    .main::before {
      content: '';
      position: absolute;
      inset: 0;
      background-image:
        linear-gradient(var(--border-subtle) 1px, transparent 1px),
        linear-gradient(90deg, var(--border-subtle) 1px, transparent 1px);
      background-size: 48px 48px;
      opacity: 0.25;
      pointer-events: none;
    }

    /* topbar */
    .topbar {
      height: 42px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      padding: 0 20px;
      gap: 10px;
      background: rgba(8, 12, 19, 0.85);
      backdrop-filter: blur(10px);
      position: relative;
      z-index: 10;
      flex-shrink: 0;
    }

    .topbar-path {
      font-size: 11px;
      color: var(--text-muted);
      letter-spacing: 0.03em;
    }

    .topbar-path span {
      color: var(--blue);
    }

    .topbar-spacer {
      flex: 1;
    }

    .model-switcher {
      display: flex;
      align-items: center;
      gap: 0;
      border: 1px solid rgba(24, 144, 255, 0.22);
      border-radius: 3px;
      overflow: hidden;
    }

    .model-btn {
      font-family: inherit;
      font-size: 9px;
      padding: 3px 8px;
      background: transparent;
      border: none;
      color: var(--text-muted);
      letter-spacing: 0.06em;
      text-transform: uppercase;
      cursor: pointer;
      transition: background 0.15s, color 0.15s;
    }

    .model-btn.active {
      background: var(--blue-dim);
      color: var(--blue);
    }

    .model-btn:hover:not(.active) {
      background: rgba(255, 255, 255, 0.04);
    }

    /* messages area */
    .messages {
      flex: 1;
      overflow-y: auto;
      padding: 24px 24px 16px;
      display: flex;
      flex-direction: column;
      gap: 22px;
      position: relative;
      z-index: 1;
      scroll-behavior: smooth;
    }

    /* welcome */
    .welcome {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 20px;
      padding: 40px 20px;
      text-align: center;
    }

    .welcome-icon {
      font-size: 44px;
      animation: float 3.5s ease-in-out infinite;
      filter: drop-shadow(0 0 18px rgba(240, 165, 0, 0.45));
    }

    @keyframes float {

      0%,
      100% {
        transform: translateY(0)
      }

      50% {
        transform: translateY(-9px)
      }
    }

    .welcome h1 {
      font-size: 20px;
      font-weight: 600;
      letter-spacing: 0.05em;
    }

    .welcome h1 span {
      color: var(--blue);
    }

    .welcome p {
      font-size: 11.5px;
      color: var(--text-secondary);
      max-width: 380px;
      line-height: 1.75;
    }

    .examples {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      max-width: 540px;
      width: 100%;
    }

    .ex-card {
      background: var(--bg-surface);
      border: 1px solid var(--border);
      border-radius: 5px;
      padding: 10px 13px;
      cursor: pointer;
      text-align: left;
      transition: border-color 0.15s, background 0.15s, transform 0.12s;
      color: var(--text-secondary);
      font-size: 11px;
      line-height: 1.55;
    }

    .ex-card:hover {
      border-color: var(--blue);
      background: var(--blue-dim);
      color: var(--text-primary);
      transform: translateY(-1px);
    }

    .ex-tag {
      font-size: 9px;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: var(--orange);
      margin-bottom: 3px;
    }

    /* message rows */
    .row {
      display: flex;
      flex-direction: column;
      gap: 4px;
      animation: slide-up 0.18s ease-out;
    }

    @keyframes slide-up {
      from {
        opacity: 0;
        transform: translateY(5px)
      }

      to {
        opacity: 1;
        transform: translateY(0)
      }
    }

    .row.user {
      align-items: flex-end;
    }

    .row.assistant {
      align-items: flex-start;
    }

    .row-label {
      font-size: 9px;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      color: var(--text-muted);
      padding: 0 3px;
    }

    .row.user .row-label {
      color: rgba(240, 165, 0, 0.6);
    }

    .row.assistant .row-label {
      color: rgba(24, 144, 255, 0.6);
    }

    .user-bubble {
      max-width: 58%;
      background: var(--bg-elevated);
      border: 1px solid rgba(240, 165, 0, 0.2);
      border-radius: 8px 8px 2px 8px;
      padding: 10px 14px;
      font-size: 12px;
      line-height: 1.65;
      color: var(--text-primary);
      white-space: pre-wrap;
      word-break: break-word;
    }

    .asst-bubble {
      width: 100%;
      background: var(--bg-surface);
      border: 1px solid var(--border);
      border-left: 3px solid var(--blue);
      border-radius: 0 7px 7px 0;
      padding: 14px 18px;
    }

    /* tool badges */
    .tool-row {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      margin-bottom: 8px;
    }

    .tbadge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 10px;
      padding: 2px 8px;
      border-radius: 2px;
      background: var(--blue-dim);
      border: 1px solid rgba(24, 144, 255, 0.2);
      color: var(--blue);
      animation: pop-in 0.14s ease-out;
      transition: background 0.3s, border-color 0.3s, color 0.3s, opacity 0.5s;
    }

    .tbadge.ok {
      background: rgba(35, 209, 139, 0.08);
      border-color: rgba(35, 209, 139, 0.2);
      color: var(--green);
    }

    .tbadge.err {
      background: rgba(241, 76, 96, 0.08);
      border-color: rgba(241, 76, 96, 0.2);
      color: var(--red);
    }

    @keyframes pop-in {
      from {
        opacity: 0;
        transform: scale(0.88)
      }

      to {
        opacity: 1;
        transform: scale(1)
      }
    }

    .gear {
      animation: spin 1.1s linear infinite;
      display: inline-block;
    }

    @keyframes spin {
      from {
        transform: rotate(0)
      }

      to {
        transform: rotate(360deg)
      }
    }

    /* markdown content */
    .md {
      font-size: 13px;
      line-height: 1.72;
      color: var(--text-primary);
    }

    .md h1,
    .md h2,
    .md h3,
    .md h4 {
      font-weight: 600;
      margin: 14px 0 7px;
      letter-spacing: 0.02em;
    }

    .md h1 {
      font-size: 17px;
      border-bottom: 1px solid var(--border);
      padding-bottom: 5px;
    }

    .md h2 {
      font-size: 14px;
      color: var(--blue);
    }

    .md h3 {
      font-size: 12.5px;
      color: var(--orange);
    }

    .md h4 {
      font-size: 12px;
      color: var(--text-secondary);
    }

    .md p {
      margin: 7px 0;
    }

    .md code {
      background: rgba(24, 144, 255, 0.1);
      border: 1px solid rgba(24, 144, 255, 0.14);
      border-radius: 2px;
      padding: 1px 5px;
      font-family: var(--font);
      font-size: 11px;
      color: #79cfff;
    }

    .md pre {
      background: #070b11 !important;
      border: 1px solid var(--border);
      border-radius: 5px;
      margin: 10px 0;
      overflow: auto;
    }

    .md pre code {
      background: none !important;
      border: none !important;
      padding: 12px 16px;
      font-size: 12px;
      color: var(--text-primary);
      display: block;
    }

    .md table {
      width: 100%;
      border-collapse: collapse;
      margin: 10px 0;
      font-size: 12px;
    }

    .md th {
      background: var(--bg-elevated);
      color: var(--blue);
      padding: 7px 12px;
      text-align: left;
      border: 1px solid var(--border);
      font-weight: 600;
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.07em;
    }

    .md td {
      padding: 6px 12px;
      border: 1px solid var(--border-subtle);
      color: var(--text-primary);
    }

    .md tr:nth-child(even) td {
      background: rgba(255, 255, 255, 0.018);
    }

    .md tr:hover td {
      background: var(--blue-dim);
    }

    .md .stars {
      font-size: 2.0em;
      letter-spacing: 2px;
    }

    .md ul,
    .md ol {
      padding-left: 18px;
      margin: 7px 0;
    }

    .md li {
      margin: 2px 0;
    }

    .md blockquote {
      border-left: 3px solid var(--orange);
      margin: 9px 0;
      padding: 7px 14px;
      background: var(--orange-dim);
      color: var(--text-secondary);
      font-style: italic;
    }

    .md a {
      color: var(--blue);
      text-decoration: none;
    }

    .md a:hover {
      text-decoration: underline;
    }

    .md strong {
      color: var(--orange);
      font-weight: 600;
    }

    .md hr {
      border: none;
      border-top: 1px solid var(--border);
      margin: 11px 0;
    }

    /* streaming cursor */
    .cursor {
      display: inline-block;
      width: 6px;
      height: 13px;
      background: var(--blue);
      margin-left: 2px;
      vertical-align: middle;
      animation: blink 0.85s step-end infinite;
    }

    @keyframes blink {

      0%,
      100% {
        opacity: 1
      }

      50% {
        opacity: 0
      }
    }

    /* thinking dots */
    .thinking {
      display: flex;
      align-items: center;
      gap: 7px;
      color: var(--text-muted);
      font-size: 11px;
      padding: 3px 0;
    }

    .dots {
      display: flex;
      gap: 3px;
    }

    .dots span {
      width: 4px;
      height: 4px;
      border-radius: 50%;
      background: var(--blue);
      animation: dot-pulse 1.3s ease-in-out infinite;
    }

    .dots span:nth-child(2) {
      animation-delay: 0.2s;
    }

    .dots span:nth-child(3) {
      animation-delay: 0.4s;
    }

    @keyframes dot-pulse {

      0%,
      80%,
      100% {
        opacity: 0.2;
        transform: scale(0.8)
      }

      40% {
        opacity: 1;
        transform: scale(1)
      }
    }

    /* error */
    .err-block {
      background: rgba(241, 76, 96, 0.08);
      border: 1px solid rgba(241, 76, 96, 0.22);
      border-radius: 3px;
      padding: 9px 13px;
      color: var(--red);
      font-size: 11px;
      margin-top: 4px;
    }

    /* â”€â”€â”€ Input â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .input-area {
      border-top: 1px solid var(--border);
      padding: 12px 20px;
      background: rgba(8, 12, 19, 0.88);
      backdrop-filter: blur(10px);
      position: relative;
      z-index: 10;
      flex-shrink: 0;
    }

    .input-wrap {
      display: flex;
      align-items: flex-end;
      gap: 9px;
      background: var(--bg-input);
      border: 1px solid var(--border);
      border-radius: 5px;
      padding: 9px 11px;
      transition: border-color 0.15s, box-shadow 0.15s;
    }

    .input-wrap:focus-within {
      border-color: var(--blue);
      box-shadow: 0 0 0 2px rgba(24, 144, 255, 0.12);
    }

    .prompt-sign {
      color: var(--blue);
      font-size: 13px;
      font-weight: 700;
      padding-bottom: 1px;
      opacity: 0.75;
      flex-shrink: 0;
    }

    textarea {
      flex: 1;
      background: transparent;
      border: none;
      outline: none;
      color: var(--text-primary);
      font-family: var(--font);
      font-size: 12px;
      line-height: 1.6;
      resize: none;
      max-height: 130px;
      min-height: 18px;
      overflow-y: auto;
    }

    textarea::placeholder {
      color: var(--text-muted);
    }

    .send {
      background: var(--blue);
      border: none;
      border-radius: 3px;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 13px;
      color: #fff;
      flex-shrink: 0;
      transition: background 0.15s, transform 0.1s;
    }

    .send:hover {
      background: #40a9ff;
    }

    .send:active {
      transform: scale(0.93);
    }

    .send:disabled {
      background: var(--bg-elevated);
      color: var(--text-muted);
      cursor: not-allowed;
      transform: none;
    }

    .hint {
      font-size: 9.5px;
      color: var(--text-muted);
      margin-top: 5px;
      display: flex;
      gap: 12px;
    }

    kbd {
      font-family: var(--font);
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-radius: 2px;
      padding: 0 3px;
      font-size: 8.5px;
      color: var(--text-secondary);
    }
  </style>
</head>

<body>
  <div class="app">

    <!-- â”€â”€ Sidebar â”€â”€ -->
    <aside class="sidebar">
      <div class="sidebar-top">
        <div class="brand">
          <span class="brand-trophy">ğŸ†</span>
          <div class="brand-text">
            <span class="brand-name">ICPC <em>Coach</em></span>
            <span class="brand-sub">Codeforces Intelligence</span>
          </div>
        </div>
        <button class="new-btn" id="newBtn">ï¼‹ &nbsp;New Session</button>
      </div>
      <div class="history-label">Session History</div>
      <div class="history-list" id="historyList">
        <div class="history-empty">No sessions yet</div>
      </div>
      <div class="sidebar-foot">
        <div class="dot"></div>
        <span>CF API Connected</span>
      </div>
    </aside>

    <!-- â”€â”€ Main â”€â”€ -->
    <main class="main">
      <div class="topbar">
        <span class="topbar-path">icpc-coach / <span>session</span></span>
        <div class="topbar-spacer"></div>
        <div class="model-switcher">
          <button class="model-btn active" data-model="claude-haiku-4-5-20251001">Haiku</button>
          <button class="model-btn" data-model="claude-sonnet-4-6">Sonnet</button>
        </div>
      </div>

      <div class="messages" id="messages">
        <div class="welcome" id="welcome">
          <div class="welcome-icon">ğŸ†</div>
          <h1>ICPC <span>Coach</span></h1>
          <p>Ask anything about Codeforces â€” users, ratings, contests, gym simulations, problem search, and standings.
          </p>
          <div class="examples" id="examples">
            <div class="ex-card" data-q="What's tourist's current rating and rank?">
              <div class="ex-tag">â–¸ User</div>
              What's tourist's current rating and rank?
            </div>
            <div class="ex-card" data-q="Show me the last 5 gyms that tourist has simulated">
              <div class="ex-tag">â–¸ Gym</div>
              Show me the last 5 gyms that tourist has simulated
            </div>
            <div class="ex-card" data-q="Find DP problems rated between 1800 and 2200">
              <div class="ex-tag">â–¸ Problems</div>
              Find DP problems rated between 1800 and 2200
            </div>
            <div class="ex-card" data-q="Show tourist's rating history over the last 10 contests">
              <div class="ex-tag">â–¸ History</div>
              Show tourist's rating history over the last 10 contests
            </div>
          </div>
        </div>
      </div>

      <div class="input-area">
        <div class="input-wrap">
          <span class="prompt-sign">â€º</span>
          <textarea id="ta" rows="1" placeholder="Ask about Codeforces users, contests, gyms, problemsâ€¦"></textarea>
          <button class="send" id="sendBtn" title="Send (Enter)">â–¶</button>
        </div>
        <div class="hint">
          <span><kbd>Enter</kbd> send</span>
          <span><kbd>Shift</kbd>+<kbd>Enter</kbd> newline</span>
        </div>
      </div>
    </main>

  </div>
  <script>
    // â”€â”€ Marked + highlight.js setup â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    marked.use({
      renderer: {
        code(code, lang) {
          const language = (lang || '').trim();
          const highlighted = language && hljs.getLanguage(language)
            ? hljs.highlight(code, { language }).value
            : hljs.highlightAuto(code).value;
          return `<pre><code class="hljs${language ? ' language-' + language : ''}">${highlighted}</code></pre>`;
        },
        link(href, title, text) {
          const titleAttr = title ? ` title="${title}"` : '';
          return `<a href="${href}"${titleAttr} target="_blank" rel="noopener noreferrer">${text}</a>`;
        },
        tablecell(content, flags) {
          const tag = flags.header ? 'th' : 'td';
          const wrapped = /[â˜…â˜†]/.test(content)
            ? `<span class="stars">${content}</span>`
            : content;
          return `<${tag}>${wrapped}</${tag}>\n`;
        }
      },
      breaks: true,
      gfm: true,
    });

    // â”€â”€ Tool labels â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const TOOL_LABELS = {
      get_gym_simulations: 'Finding gym simulations',
      get_user_info: 'Fetching user profile',
      get_user_rating: 'Loading rating history',
      get_user_submissions: 'Getting submissions',
      get_contest_list: 'Browsing contests',
      get_contest_standings: 'Loading standings',
      get_contest_status: 'Fetching contest status',
      get_contest_rating_changes: 'Getting rating changes',
      get_problems: 'Searching problems',
      get_recent_actions: 'Loading recent activity',
      get_rated_list: 'Loading leaderboard',
    };

    // â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let messages = [];
    let sessions = [];           // [{ label, messages }]
    let activeSession = -1;
    let selectedModel = 'claude-haiku-4-5-20251001';

    // Model switcher
    document.querySelectorAll('.model-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.model-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        selectedModel = btn.dataset.model;
      });
    });
    let streaming = false;
    let msgCounter = 0;

    // â”€â”€ DOM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const $messages = document.getElementById('messages');
    const $welcome = document.getElementById('welcome');
    const $history = document.getElementById('historyList');
    const $ta = document.getElementById('ta');
    const $send = document.getElementById('sendBtn');
    const $newBtn = document.getElementById('newBtn');

    // â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const esc = s => { const d = document.createElement('div'); d.textContent = s; return d.innerHTML; };
    const uid = () => ++msgCounter;
    const scrollBot = () => { $messages.scrollTop = $messages.scrollHeight; };

    // â”€â”€ Auto-resize textarea â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    $ta.addEventListener('input', () => {
      $ta.style.height = 'auto';
      $ta.style.height = Math.min($ta.scrollHeight, 130) + 'px';
    });

    // â”€â”€ Example cards â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    document.getElementById('examples').addEventListener('click', e => {
      const card = e.target.closest('.ex-card');
      if (card) { $ta.value = card.dataset.q; $ta.dispatchEvent(new Event('input')); $ta.focus(); }
    });

    // â”€â”€ Keyboard â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    $ta.addEventListener('keydown', e => {
      if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); send(); }
    });
    $send.addEventListener('click', send);
    $newBtn.addEventListener('click', newSession);

    // â”€â”€ New session â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function newSession() {
      messages = [];
      activeSession = -1;
      $messages.querySelectorAll('.row').forEach(r => r.remove());
      $welcome.style.display = 'flex';
      $ta.value = ''; $ta.style.height = 'auto';
      renderHistory();
      $ta.focus();
    }

    // â”€â”€ Render sidebar history â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function renderHistory() {
      if (!sessions.length) {
        $history.innerHTML = '<div class="history-empty">No sessions yet</div>';
        return;
      }
      $history.innerHTML = sessions.map((s, i) =>
        `<div class="history-item${i === activeSession ? ' active' : ''}" data-i="${i}">
       <span class="idx">#${sessions.length - i}</span>${esc(s.label)}
     </div>`
      ).join('');
      $history.querySelectorAll('.history-item').forEach(el =>
        el.addEventListener('click', () => restoreSession(+el.dataset.i))
      );
    }

    // â”€â”€ Restore session â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function restoreSession(i) {
      const s = sessions[i];
      if (!s) return;
      activeSession = i;
      messages = [...s.messages];
      $messages.querySelectorAll('.row').forEach(r => r.remove());
      $welcome.style.display = 'none';
      messages.forEach(m => {
        if (m.role === 'user') {
          $messages.appendChild(makeUserRow(m.content));
        } else {
          const row = makeAsstRow();
          row.querySelector('.md').innerHTML = marked.parse(m.content);
          row.querySelectorAll('pre code').forEach(b => hljs.highlightElement(b));
          $messages.appendChild(row);
        }
      });
      scrollBot();
      renderHistory();
    }

    // â”€â”€ Build DOM rows â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function makeUserRow(text) {
      const row = document.createElement('div');
      row.className = 'row user';
      row.innerHTML = `<div class="row-label">you</div><div class="user-bubble">${esc(text)}</div>`;
      return row;
    }

    function makeAsstRow() {
      const id = uid();
      const row = document.createElement('div');
      row.className = 'row assistant';
      row.innerHTML = `
    <div class="row-label">icpc coach</div>
    <div class="asst-bubble">
      <div class="tool-row" id="tr${id}"></div>
      <div class="md" id="md${id}"></div>
    </div>`;
      return row;
    }

    // â”€â”€ Send â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function send() {
      const text = $ta.value.trim();
      if (!text || streaming) return;
      streaming = true;
      $send.disabled = true;
      $welcome.style.display = 'none';

      messages.push({ role: 'user', content: text });
      $messages.appendChild(makeUserRow(text));
      $ta.value = ''; $ta.style.height = 'auto';
      scrollBot();

      // assistant placeholder
      const asstRow = makeAsstRow();
      $messages.appendChild(asstRow);
      const $tr = asstRow.querySelector('[id^="tr"]');
      const $md = asstRow.querySelector('[id^="md"]');

      // thinking indicator
      const thinkEl = document.createElement('div');
      thinkEl.className = 'thinking';
      thinkEl.innerHTML = `<div class="dots"><span></span><span></span><span></span></div><span>Analyzingâ€¦</span>`;
      $md.appendChild(thinkEl);
      scrollBot();

      let accumulated = '';
      let toolBadges = {};
      let thinkGone = false;

      function hideThink() {
        if (!thinkGone) { thinkEl.remove(); thinkGone = true; }
      }

      try {
        const res = await fetch('/api/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ messages, model: selectedModel }),
        });

        if (!res.ok) throw new Error(`HTTP ${res.status}`);

        const reader = res.body.getReader();
        const dec = new TextDecoder();
        let buf = '';

        while (true) {
          const { done, value } = await reader.read();
          if (done) break;
          buf += dec.decode(value, { stream: true });
          const lines = buf.split('\n');
          buf = lines.pop();

          for (const line of lines) {
            if (!line.startsWith('data: ')) continue;
            const raw = line.slice(6).trim();
            if (!raw) continue;
            let ev;
            try { ev = JSON.parse(raw); } catch { continue; }

            if (ev.type === 'text') {
              hideThink();
              accumulated += ev.content;
              $md.innerHTML = marked.parse(accumulated) + '<span class="cursor"></span>';
              $md.querySelectorAll('pre code:not(.hljs)').forEach(b => hljs.highlightElement(b));
              scrollBot();

            } else if (ev.type === 'tool_call') {
              hideThink();
              const label = TOOL_LABELS[ev.name] || ev.name;
              const badge = document.createElement('div');
              badge.className = 'tbadge';
              badge.innerHTML = `<span class="gear">âš™</span> ${label}â€¦`;
              $tr.appendChild(badge);
              toolBadges[ev.name] = badge;
              scrollBot();

            } else if (ev.type === 'tool_result') {
              const badge = toolBadges[ev.name];
              if (badge) {
                badge.classList.add(ev.success ? 'ok' : 'err');
                badge.innerHTML = (ev.success ? 'âœ“' : 'âœ—') + ' ' + (TOOL_LABELS[ev.name] || ev.name);
                setTimeout(() => { badge.style.opacity = '0'; setTimeout(() => badge.remove(), 500); }, 2200);
              }

            } else if (ev.type === 'retrying') {
              hideThink();
              // Show or update a rate-limit badge
              let retryBadge = $md.querySelector('.retry-notice');
              if (!retryBadge) {
                retryBadge = document.createElement('div');
                retryBadge.className = 'retry-notice err-block';
                $md.appendChild(retryBadge);
              }
              let secs = ev.waitSeconds;
              retryBadge.textContent = `â³ Rate limit reached â€” retrying in ${secs}sâ€¦`;
              const tick = setInterval(() => {
                secs--;
                if (secs <= 0) { clearInterval(tick); retryBadge.textContent = 'â†» Retryingâ€¦'; }
                else retryBadge.textContent = `â³ Rate limit reached â€” retrying in ${secs}sâ€¦`;
              }, 1000);
              scrollBot();

            } else if (ev.type === 'done') {
              $md.querySelector('.retry-notice')?.remove();
              $md.querySelector('.cursor')?.remove();
              if (accumulated) {
                $md.innerHTML = marked.parse(accumulated);
                $md.querySelectorAll('pre code').forEach(b => hljs.highlightElement(b));
              } else {
                hideThink();
              }
              scrollBot();

            } else if (ev.type === 'error') {
              hideThink();
              const errEl = document.createElement('div');
              errEl.className = 'err-block';
              errEl.textContent = `Error: ${ev.message}`;
              $md.appendChild(errEl);
              scrollBot();
            }
          }
        }
      } catch (err) {
        hideThink();
        const errEl = document.createElement('div');
        errEl.className = 'err-block';
        errEl.textContent = `Connection error: ${err.message}`;
        $md.appendChild(errEl);
        if (!accumulated) accumulated = `*Connection error: ${err.message}*`;
        scrollBot();
      }

      // Save assistant response to history
      if (accumulated) messages.push({ role: 'assistant', content: accumulated });

      const firstUser = messages.find(m => m.role === 'user');
      const label = firstUser ? firstUser.content.slice(0, 58) : 'Session';
      if (activeSession === -1) {
        sessions.unshift({ label, messages: [...messages] });
        activeSession = 0;
      } else {
        sessions[activeSession].messages = [...messages];
      }

      renderHistory();
      streaming = false;
      $send.disabled = false;
      $ta.focus();
    }
  </script>
</body>

</html>